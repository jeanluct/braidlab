#!/bin/bash

# Insert the 'GNU boilerplate language' between two tags.
#
# Run this as
#
#  ./devel/insertboiler <base_directory>
#
# It will recurse down the directory.  The file COPYING needs to be in
# the folder where the command is executed.

if [ $# -eq 0 ]; then
    ROOTDIR=.
else
    # Get directory from command-line, stripping trailing slash.
    ROOTDIR=${1%/}
fi
export BPFILE=COPYING

function checktag() {
    if [ -z "$2" ]; then return 1; fi

    if !(grep --quiet "$1" $2); then
	echo "Warning: file" $2 "is missing \"$1\" tag."
	return 1
    fi

    return 0
}
export -f checktag

function ibtag() {
    export OPENTAG=${1}' <LICENSE'
    export CLOSETAG=${1}' LICENSE>'

    if !(checktag "$OPENTAG" ${2}); then exit 1; fi
    if !(checktag "$CLOSETAG" ${2}); then exit 1; fi

    # Add comment character to start of boilerplate text.
    sed "s,^,${1}   ," ${BPFILE} >| ${BPFILE}.comment
    # Insert boilerplate text.
    sed -i \
	"/${OPENTAG}/,/${CLOSETAG}/ {//!d}; /${OPENTAG}/r ${BPFILE}.comment" $2
    rm -f ${BPFILE}.comment
    # Remove trailing whitespace, if rtw command is available.
    if hash rtw 2> /dev/null; then
	rtw ${2}; rm -f ${2}.rtw
    fi
}
export -f ibtag

# bibtex doesn't like @ characters anywhere else than to start bib entries,
# even in comments.  So replace the @ by (at) in email addresses.
function bibatfix() {
    sed -i "s/${1}\@/${1}(at)/g" ${2}
}
export -f bibatfix

# Insert boilerplate for various file extensions.
find $ROOTDIR -name "*.m" -print0 | \
    xargs -0 -n 1 bash -c 'ibtag "%" "$@"' _
find $ROOTDIR -name "*.[ch]pp" -print0 | \
    xargs -0 -n 1 bash -c 'ibtag "\/\/" "$@"' _
find $ROOTDIR -name "*.c" -print0 | \
    xargs -0 -n 1 bash -c 'ibtag "" "$@"' _
find $ROOTDIR -name "*.tex" -print0 | \
    xargs -0 -n 1 bash -c 'ibtag "%" "$@"' _
find $ROOTDIR -name "*.bib" -print0 | \
    xargs -0 -n 1 bash -c 'ibtag "%" "$@"' _
find $ROOTDIR -name "Makefile*" -print0 | \
    xargs -0 -n 1 bash -c 'ibtag "#" "$@"' _

# Fix emails in bib files (hardwired list, unfortunately).
for emailname in jeanluc marko allshouse; do
    find $ROOTDIR -name "*.bib" -print0 | \
	xargs -0 -n 1 bash -c 'bibatfix '${emailname}' "$@"' _
done

unset -f checktag
unset -f ibtag
unset -f bibatfix
unset BPFILE
unset OPENTAG
unset CLOSETAG
